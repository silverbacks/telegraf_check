# Azure Monitoring Configuration
# This configuration file focuses on Azure-specific metrics and events

# Azure VM metadata input
# This collects static information about the VM such as:
# - Location (region where the VM is deployed)
# - Name (VM name)
# - OS Type (Linux or Windows)
# - VM Size (compute size e.g., Standard_D2s_v3)
# 
# Example metrics generated:
# azure_vm_metadata,compute_location=eastus,compute_name=myvm,compute_osType=Linux,compute_vmSize=Standard_D2s_v3 compute_location="eastus",compute_name="myvm",compute_osType="Linux",compute_vmSize="Standard_D2s_v3"
# 
# Note: No proxy settings are specified to ensure direct access to the Azure Instance Metadata Service
[[inputs.http]]
  urls = ["http://169.254.169.254/metadata/instance?api-version=2021-02-01"]
  method = "GET"
  headers = {"Metadata" = "true"}
  data_format = "json"
  json_string_fields = ["compute/location", "compute/name", "compute/osType", "compute/vmSize"]
  tag_keys = ["compute/location", "compute/name", "compute/osType", "compute/vmSize"]
  name_override = "azure_vm_metadata"

# Azure scheduled events input
# This collects information about upcoming maintenance events such as:
# - Event Type (Freeze, Reboot, Redeploy, Preempt, Terminate)
# - Resource Type (VirtualMachine)
# - Resources (affected VM names)
# - Event ID (unique identifier)
# - Status (Scheduled, Started, etc.)
# - NotBefore (when the event will start)
# - Description (event description)
# - EventSource (Platform or User)
# - DurationInSeconds (event duration)
#
# Example metrics generated:
# azure_scheduled_events,EventType=Freeze,ResourceType=VirtualMachine,Resources=myvm EventId="12345",Status="Scheduled",NotBefore="2023-01-01T12:00:00Z",Description="Test",EventSource="Platform",DurationInSeconds=120
# 
# Note: No proxy settings are specified to ensure direct access to the Azure Instance Metadata Service
[[inputs.http]]
  urls = ["http://169.254.169.254/metadata/scheduledevents?api-version=2020-07-01"]
  method = "GET"
  headers = {"Metadata" = "true"}
  data_format = "json"
  json_query = "Events"
  name_override = "azure_scheduled_events"
  json_string_fields = ["EventId", "EventType", "ResourceType", "Resources", "EventStatus", "NotBefore", "Description", "EventSource"]
  tag_keys = ["EventType", "ResourceType", "Resources", "EventStatus", "EventSource"]
  [inputs.http.tagdrop]
    EventType = [""]

# Exec input to run the Azure VM maintenance events detection script
# This runs our custom script that specifically detects Freeze, Reboot, and Redeploy events
# and generates simple gauge metrics:
# azure_vm_freeze_event value=0
# azure_vm_reboot_event value=1
# azure_vm_redeploy_event value=0
[[inputs.exec]]
  commands = ["/usr/local/bin/azure_vm_freeze_monitor.sh --check-only"]
  timeout = "10s"
  data_format = "influx"
  name_override = "azure_vm_maintenance_events"
  interval = "60s"